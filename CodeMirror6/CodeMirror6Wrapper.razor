@namespace CodeMirror6

@implements IAsyncDisposable

@inject IJSRuntime JSRuntime


<div id=@Id />


@code
{
    [Parameter] public string Id { get; set; } = $"CodeMirror6_Editor_{Guid.NewGuid().ToString()}";
    [Parameter] public int TabSize { get; set; } = 2;
    [Parameter] public int IndentationUnit { get; set; } = 2;
    [Parameter] public string? Doc { get; set; }
    [Parameter] public EventCallback<string?> DocChanged { get; set; }
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public EventCallback<bool> FocusChanged { get; set; }
    [Parameter] public List<SelectionRange>? Selection { get; set; }
    [Parameter] public EventCallback<List<SelectionRange>?> SelectionChanged { get; set; }
    [Parameter] public ThemeMirrorTheme? Theme { get; set; }
    [Parameter] public bool ReadOnly { get; set; }
    [Parameter] public bool Editable { get; set; } = true;
    [Parameter] public CodeMirrorLanguage? Language { get; set; } = CodeMirrorLanguage.Markdown;

    private CodeMirrorJsInterop? CmJsInterop = null;
    private bool hasFocus;
    private bool shouldRender = true;

    public CodeMirrorConfiguration Config = null!;

    /// <summary>
    /// The document contents has changed
    /// </summary>
    /// <param name="value"></param>
    /// <returns></returns>
    [JSInvokable]
    public async Task DocChangedFromJS(string value)
    {
        if (Doc?.Replace("\r", "") == value?.Replace("\r", "")) return;
        Doc = value?.Replace("\r", "") ?? "";
        Config.Doc = Doc;
        await DocChanged.InvokeAsync(Doc);
    }

    /// <summary>
    /// The document focus has changed
    /// </summary>
    /// <param name="value"></param>
    /// <returns></returns>
    [JSInvokable]
    public async Task FocusChangedFromJS(bool value)
    {
        if (hasFocus == value) return;
        hasFocus = value;
        await FocusChanged.InvokeAsync(hasFocus);
        if (!hasFocus) await SelectionChanged.InvokeAsync(null);
    }

    /// <summary>
    /// The cursor position or selections have changed
    /// </summary>
    /// <param name="value"></param>
    /// <returns></returns>
    [JSInvokable]
    public async Task SelectionSetFromJS(IEnumerable<SelectionRange>? value)
    {
        Selection = value?.ToList();
        await SelectionChanged.InvokeAsync(Selection);
    }

    /*
    [JSInvokable] public async Task<string> UploadFileBlob(string base64, string fileName) => await DoUploadFileBlob(base64, fileName);
    [JSInvokable] public async Task<string> RequestPasteAction(string[] options) => await DoRequestPasteAction(options);
    */

    protected override void OnInitialized()
    {
        Config = new CodeMirrorConfiguration(
            Doc,
            Placeholder,
            Theme?.ToString(),
            TabSize,
            IndentationUnit,
            ReadOnly,
            Editable,
            Language?.ToString()
        );
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) {
            if (CmJsInterop is null) {
                CmJsInterop = new CodeMirrorJsInterop(JSRuntime, this);
                await CmJsInterop.InitCodeMirror();
            }
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        shouldRender = true;
        if (CmJsInterop is null) return;
        shouldRender = false;
        if (Config.TabSize != TabSize) {
            Config.TabSize = TabSize;
            await CmJsInterop.SetTabSize();
        }
        if (Config.IndentationUnit != IndentationUnit) {
            Config.IndentationUnit = IndentationUnit;
            await CmJsInterop.SetIndentUnit();
        }
        if (Config.Doc?.Replace("\r", "") != Doc?.Replace("\r", "")) {
            Config.Doc = Doc;
            await CmJsInterop.SetDoc();
        }
        if (Config.Placeholder != Placeholder) {
            Config.Placeholder = Placeholder;
            await CmJsInterop.SetPlaceholderText();
        }
        if (Config.ThemeName != Theme?.ToString()) {
            Config.ThemeName = Theme?.ToString();
            await CmJsInterop.SetTheme();
        }
        if (Config.ReadOnly != ReadOnly) {
            Config.ReadOnly = ReadOnly;
            await CmJsInterop.SetReadOnly();
        }
        if (Config.Editable != Editable) {
            Config.Editable = Editable;
            await CmJsInterop.SetEditable();
        }
        if (Config.LanguageName != Language?.ToString()) {
            Config.LanguageName = Language?.ToString();
            await CmJsInterop.SetLanguage();
        }
        shouldRender = true;
    }

    protected override bool ShouldRender() => shouldRender;

    public async ValueTask DisposeAsync()
    {
        if (CmJsInterop is not null)
            await CmJsInterop.DisposeAsync();
    }
}
